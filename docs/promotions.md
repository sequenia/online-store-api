# Промоакции

## Введение

Промоакции предоставляют пользователю возможность получить скидку на заказ при выполнении определенных условий.

Промоакции могут влиять на стоимость:
- Позиции заказа,
- Всего заказа,
- Доставки,
- Чего-то ещё, в зависимости от магазина.

Примеры промоакций:
- Добавьте в корзину 3 футболки и вы получите скидку 10% на каждую из них.
- Оформите заказ более чем на 1000 рублей, и мы выполним доставку бесплатно.
- При вводе промокода "ПРАЗДНИК" вы получите скидку на весь заказ 20%.

В данной инструкции описаны структура данных и REST API. Описание и реализация алгоритмов применения промоакций не предусматривается.

## Структура данных

Промоакция, как правило, подразумевает корректировку стоимости чего-либо в заказе пользователя. Однако, не только промоакции могут корректировать стоимость. Например:
- Если налог с продажи не включен в стоимость товара, то его стоимость может быть увеличена на сумму налога в момент оформления заказа.
- Магазин может включать сервисный сбор при оформлении заказа, что скажется на общей стоимости заказа.

Таким образом, можно создать универсальный механизм по корректировке стоимостей. Заведите особую сущность "Корректировка", которая будет хранить следующую информацию:
- Корректируемый объект (позиция заказа, заказ, доставка),
- Источник корректировки (промоакция, налог, сервисный сбор),
- Сумма корректировки в абсолютном значении.

Можно завести дополнительное поле "Заголовок", в котором будет храниться краткое пояснение для пользователя - на основе чего сработала корректировка. Это будет удобно в том случае, если информация об источнике корректировки поменяется, а пользователю нужно будет показывать старую информацию, актуальную на момент оформления заказа.

Таблица "Корректировки":

```sql
CREATE TABLE adjustments
(
  id bigserial PRIMARY KEY, -- Идентификатор корректировки
  adjustable_id bigint, -- Идентификатор корректируемого объекта
  adjustable_type character varying, -- Тип корректируемого объекта
  source_id bigint, -- Идентификатор источника корректировки
  source_type character varying, -- Тип источника корректировки
  label character varying, -- Заголовок с описанием корректировки,
  price numeric(8, 2) -- Значение, на которое производится корректировка
);

CREATE INDEX index_adjustments_on_adjustable_type_and_adjustable_id
  ON adjustments
  (adjustable_type, adjustable_id);

CREATE INDEX index_adjustments_on_source_type_and_source_id
  ON adjustments
  (source_type, source_id);
```

В данной таблице ссылки на корректируемый объект и источник корректировки созданы в виде полиморфной связи. В поле с суффиксом `type` записывается тип объекта, а в поле с суффиксом `id` - его идентификатор. Тип однозначно определяет таблицу, в которой хранится объект. Таким образом, корректируемые объекты могут быть разных типов, так же как и источники корректировки.

## Выдача корректировок в API

Клиентскому приложению корректировки могут понадобиться при работе с корзиной и оформлением заказа. В пользовательском интерфейсе обычно необходимо отобразить:
- Информацию о корректировках в тех местах, где они сработали (позиция заказа, заказ, доставка).
- Сводку о том, каким образом сформировалась итоговая стоимость заказа.

О каждой части заказа может понадобиться отобразить:
- Стоимость без корректировок,
- Стоимость с корректировками,
- Итоговую сумму корректировок,
- и что-то ещё.

Чтобы не усложнять клиентское приложение, произведите все необходимые расчеты на сервере и выдайте в API информацию о всех ценах, которые нужно отобразить.

Пример структуры данных и выдачи информации о заказе с корректировками (Не связанная с корректировками информация не указана):

```java
public class Order {
  private Long id;
  private List<OrderItem> items;
  private Shipment shipment;
  private List<Adjustment> adjustments;

  // Сумма стоимостей всех позиций заказа с учетом их корректировок
  private Price itemsTotal;

  // Сумма корректировок заказа
  private Price adjustmentsTotal;

  // Сумма стоимостей всех позиций заказа с учетом их корректировок и корректировок заказа
  private Price total;
}

public class OrderItem {
  private Long id;
  private Int count;
  private List<Adjustment> adjustments;

  // Стоимость варианта без учета корректировок
  private Price originalPrice;

  // Стоимость позиции заказа без учета корректировок
  private Price originalTotal;

  // Сумма корректировок позиции заказа
  private Price adjustmentsTotal;

  // Стоимость варианта с учетом корректировок
  private Price price;

  // Стоимость позиции заказа с учетом корректировок
  private Price total;
}

public class Shipment {
  private Long id;
  private List<Adjustments> adjustments;

  // Стоимость получения заказа без учета корректировок на момент оформления заказа
  private Price originalPrice;

  // Сумма корректировок получения заказа
  private Price adjustmentsTotal;

  // Стоимость получения заказа с учетом корректировок
  private Price total;
}

public class Adjustment {
  private Long id;
  private String sourceType;
  private Price price;
  private String label;
}

public class Price {
  private BigDecimal amount;
}
```

```json
{
  "order": {
    "id": 1,
    "items": [
      {
        "id": 1,
        "count": 3,
        "adjustments": [
          {
            "id": 1,
            "sourceType": "promotion",
            "price": {
              "amount": "-10.00"
            },
            "label": "Закажи 3 футболки и получи скидку 10% на каждую из них"
          }
        ],
        "originalPrice": {
          "amount": "100.00"
        },
        "originalTotal": {
          "amount": "300.00"
        },
        "adjustmentsTotal": {
          "amount": "-10.00"
        },
        "price": {
          "amount": "90.00"
        },
        "total": {
          "amount": "270.00"
        }
      }
    ],
    "adjustments": [
      {
        "id": 1,
        "sourceType": "promotion",
        "price": {
          "amount": "-54.00"
        },
        "label": "Укажи промокод \"ПРАЗДНИК\" и получи скидку 20% на весь заказ"
      }
    ],
    "itemsTotal": {
      "amount": "270.00"
    },
    "adjustmentsTotal": {
      "amount": "-54.00"
    },
    "total": {
      "amount": "216.00"
    },
    "shipment": {
      "id": 1,
      "adjustments": [
        {
          "id": 1,
          "sourceType": "promotion",
          "price": {
            "amount": "-50.00"
          },
          "label": "Оформите заказ более чем на 100 рублей, и мы выполним доставку бесплатно."
        }
      ],
      "originalPrice:": {
        "amount": "50.00"
      },
      "adjustmentsTotal": {
        "amount": "-50.00"
      },
      "total": {
        "amount": "00.00"
      }
    }
  }
}
```
