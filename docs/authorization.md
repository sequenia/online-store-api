# Авторизация

## Введение

Взаимодействие клиенсткой и серверной частей происходит по протоколу HTTP, который не сохраняет своё состояние (stateless). Значит запросы от клиента к серверу являются полностью независимыми друг от друга, и нужно самостоятельно придумать механизм сохранения состояния между запросами.

До некоторого времени многие веб-приложения использовали механизм сессий для этих целей и хранили сессию в cookies браузера. Сессия представляет собой набор данных, которые подставляются клиентом в каждый запрос к серверу и могут быть отредактированы сервером в момент выполнения запроса. Отредактированная сессия возвращается на клиент после каждого запроса и должна быть снова сохранена на клиенте.

Однако, механизм сессий не является удобным способом при взаимодействии по API и при множестве разных типов клиентов по следующим причинам:

1. Если после каждого запроса сессия может быть отредактирована сервером и должна быть заново сохранена на клиент, значит нельзя выполнять запросы параллельно.
2. Не все типы клиентов поддерживают функциональность cookies по-умолчанию.

Удобным и универсальным способом являются **маркеры доступа** (**Access Token**). Это некие ключи, которые единожды выдаются для клиента сервером, подставляются клиентом в каждый запрос (например, в заголовки) и используются для идентификации клиента. Преимущества:

1. Access Token не может быть изменён со стороны сервера после каждого запроса, что позволяет совершать параллельные запросы.
2. Может быть сохранён в любом хранилище данных, которое поддерживает клиент.

Частным случаем Access Token-а являются [JSON Web Token-ы](https://ru.wikipedia.org/wiki/JSON_Web_Token). Из-за распространенности данного стандарта и строгой спецификации он является предпочтительным способом реализации Access Token-ов.

## Неавторизованные пользователи

По статусу авторизации можно разделить пользователей интенет-магазина на 2 типа:
1. Авторизованные. Это пользователи, которые прошли процедуру аутентификации.
2. Неавторизованные, которые не прошли процедуру аутентификации. Можно сказать, что это анонимные пользователи.

Интернет-магазин не должен запрещать неавторизованным пользователям просматривать каталог товаров, добавлять их в корзину и выполнять ещё ряд действий, специфических для конкретного интернет-магазина. Однако, в структуре данных интернет-магазина имеются сущности, которые предполагают наличие пользователя, например, корзина.

Чтобы не разделять алгоритмы работы авторизованных и неавторизованных пользователей, следует на уровне базы данных завести у пользователя статус авторизации. Для клиента, который первый раз обращается к серверу, нужно завести нового пользователя в базе данных в статусе "Неавторизован" и выдать ему Access Token, который будет передаваться клиентом в каждый запрос в таком же виде, как и для авторизованного пользователя.

Таким образом, сервер сможет предоставить весь функционал как для авторизованного, так и для неавторизованного пользователя, а клиенту не нужно будет вводить специфическую логику для обработки ситуаций, когда пользователь неавторизован.

Однако, нужно корректно обработать переход пользователя из неавторизованного статуса в авторизованный:
1. Если переход случился в случае регистрации, тогда достаточно лишь сменить тип авторизации у пользователя в базе данных.
2. Если переход случился в случае аутентификации, тогда необходимо произвести слияние данных двух учетных записей - текущей неавторизованной и существующей авторизованной.

Если невторизованный пользователь добавил товары в корзину, а потом авторизовался под уже существующей учетной записью, необходимо произвести слияние двух корзин, потому что в существующей учетной записи тоже могла быть корзина с товарами.
